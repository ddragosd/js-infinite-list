<!DOCTYPE html>
<html>

<head>
    <title>Window Scroll Example with Tweeter</title>
    <script type="text/javascript" src="js/jquery-1.7.2.js"></script>
    <script type="text/javascript" src="js/infinite-list-1.1-SNAPSHOT.js"></script>
    <script type="text/javascript" src="js/mustache.js"></script>
    <script type="text/javascript" src="js/TwitterFeedLoader.js"></script>

    <script type="text/javascript" src="js/iscroll.js"></script>

    <link rel="stylesheet" href="css/iScroll-demo.css">
</head>

<body>

<h3>Example showing Infinite List with iScroll and Manual loading policy</h3>

<p>
    The example is using the iScroll4 <a href="http://cubiq.org/dropbox/iscroll4/examples/pull-to-refresh/">demo</a>
    with
    "pull up to load more" handler
</p>

<div id="wrapper">
    <div id="scroller">
        <div id="tweets">
            <p></p>
        </div>

        <div id="pullUp">
            <span class="pullUpIcon"></span><span class="pullUpLabel">Pull up to refresh...</span>
        </div>
    </div>
</div>


<script id="tweetItem" type="text/template">
    <p>
        <img src="{{profile_image_url}}" alt="profile_image_url">
        {{text}}
    </p>
</script>

<script type="text/javascript">

    var myScroll;

    var dataProvider = new iList.LazyDataProvider({
        loadPolicy:     new iList.loadPolicy.ManualLoadPolicy(), //manual load policy is not listening to any el
        loader:         new TwitterFeedLoader({
            query: "adobe",   // search query
            rpp: 10,          // results per page
            startPage: 1      // page to start with
        })
    })

    var list = new iList.InfiniteList({
        // VIEW configuration
        container:              $("#tweets"),
        itemRendererTemplate:   $("#tweetItem").html(),
        // templating function. you can hook in other templating libs such as Underscore, or any other lib
        templateFunction:       Mustache.to_html,

        // DOMAIN configuration
        dataProvider:           dataProvider  })

    //initialize iScroll
    var pullUpAction = function ()
    {
        dataProvider.loadMore()
    }
    var pullUpEl = document.getElementById('pullUp');
    var pullUpOffset = pullUpEl.offsetHeight;

    myScroll = new iScroll("wrapper", {
        hScrollbar: false,
        useTransition: true,
        onRefresh: function ()
        {
            if (pullUpEl.className.match('loading'))
            {
                pullUpEl.className = '';
                pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Pull up to load more...';
            }
        },
        onScrollMove: function ()
        {
            if (this.y < (this.maxScrollY - 5) && !pullUpEl.className.match('flip'))
            {
                pullUpEl.className = 'flip';
                pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Release to refresh...';
                this.maxScrollY = this.maxScrollY;
            } else if (this.y > (this.maxScrollY + 5) && pullUpEl.className.match('flip'))
            {
                pullUpEl.className = '';
                pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Pull up to load more...';
                this.maxScrollY = pullUpOffset;
            }
        },
        onScrollEnd: function ()
        {
            if (pullUpEl.className.match('flip'))
            {
                pullUpEl.className = 'loading';
                pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Loading...';
                pullUpAction();	// Execute custom function (ajax call?)
            }
        }
    });


    // listen for 'dataLoaded' in order to refresh the iScroll
    var __bind = function(fn, me) { return function() { return fn.apply(me, arguments); }; };
    $(dataProvider).on("dataLoaded", function()
    {
        setTimeout(__bind(myScroll.refresh, myScroll), 300);
        if ( dataProvider.gotEmptyResults ) {
            $(pullUpEl).hide();
        }
    })

    // start loading the first page with tweets
    dataProvider.loadMore();

    setTimeout(function () { document.getElementById('wrapper').style.left = '0'; }, 800);

    // hack to prevent ellastic scrolling
    document.addEventListener(
            'touchmove', function(e) {
                e.preventDefault();
            }, false
    );

</script>


</body>

</html>